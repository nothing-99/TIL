# 쿠키

- 서버가 브라우저에게 전달하는 쿠키(Cookie)는 단순 **"텍스트 데이터"** 이다. 하지만 쿠키의 역할은 단순하지 않다.

- 서버는 이 쿠키값을 이용해서 브라우저(Client)를 식별하고 식별한 대상에 따라 다른 UI/UX를 주기도 한다.

- 쿠키는 브라우저에 의해 관리된다. 쿠키는 일반적으로 개인정보를 담고 있기 때문에 사용자가 임의로 거부하거나 삭제할 수도 있다. 하지만, 서버가 쿠키를 이용해 사용자를 식별하고 다른 UI/UX를 선사하기 때문에 되도록이면 쿠키를 허용하는 것이 좋다.

- 웹앱에서 로그인 정보, 사용자 설정등을 저장하고 유지하는 중요한 역할을 수행한다.

## 쿠키 생성

웹 서버는 `Set-Cookie` HTTP 헤더를 통해 브라우저에 쿠키 정보를 전달한다.

```http
Set-Cookie: value[; expires=data][; domain=domain][; path=path][; secure]
```

- value 이외데도 expires, domain, path, secure 옵션을 설정할 수 있는데 해당 옵션들은 브라우저에서만 사용되고 서버나 다른 클라이언트에 가져올 수 없다. 당연하게도 서버에서 브라우저로 전달된 쿠키는 브라우저 내에 있는 데이터 저장소에 저장되기 때문이다.

브라우저는 `Cookie` HTTP 헤더를 통해 서버에 쿠키값을 전달한다.

```http
Cookie: value
```

- **value** 는 문자열이고 일반적으로 `name=value` 의 형태를 가진다. 이 형태는 validation도 없고 강제하는 것이 아니다. 하지만 통상적으로 이용한다면 따르는 것이 좋다.

서버는 브라우저에게 여러개의 **Set-Cookie**를 통해 여러개의 쿠키를 브라우저에 전달할 수 있는데 브라우저가 여러개의 쿠키를 하나의 **Cookie**로 전달할 수 있다.

```http
Cookie: name=value1; name=value2; name=value3
```

- 세미클론과 공백을 통해 쿠키값을 구분한다.

## 쿠키 인코딩

쿠키공식문서에서는 URL인코딩 등 인코딩을 필수적인 것으로 요구하지 않는다. 단지 쉼표, 세미클론, 공백에 대해서는 인코딩을 하도록 명시하고 있다.

대부분 구현에서 **URL 인코딩**을 적용한다. 간단한 이유는 쿠키값이 특정문자를 포함할 때 문제가 발생하는 것을 방지하기 위해서다. 만약 세미클론이나 쉽표를 포함하고 있을 경우 쿠키분석을 위한 구분자로 인식될 수 있다. 즉, 쿠키 값을 안전하게 저장하고 전송할 수 있다.

## Expires 옵션

- 쿠키의 만료기간(수명)을 결정하는 옵션
  - 설정 ✅ : 브라우저를 종료하더라도 설정한 날짜까지 유효한 쿠키로 남는 **presistent cookie** 로 취급
  - 설정 ❌ : 브라우저를 종료하면 사라지는 **session cookie** 로 취급
- expires 옵션을 설정하지 않거나 과거날짜로 지정하면 쿠키는 브라우저에 의해 삭제된다.

```http
Wdy, DD Mon YYYY HH:MM:SS GMT
```

```http
Thu, 01 Jan 1970 00:00:00 GMT
```

## Domain 옵션

**쿠키값을 전송할 도메인을 명시하는 옵션**이고 여러개의 도메인을 명시할 수 있다. 그리고 **하위 도메인에 대해서 쿠키를 공유**할 수 있도록 한다.

하위 도메인에 대해 하나의 쿠키로 공유할 시 불필요한 쿠키전송이 줄어들어 네트워크 속도가 향상된다.

도메인 옵션을 설정할 때 주의할 점은 **도메인 옵션을 설정한 값이 `Set-Cookie` 헤더를 보내는 호스트 이름의 일부어야 한다**. 올바르지 않은 도메인 옵션은 무시되며 쿠키가 설정되지 않는다. 즉, 브라우저가 요청을 보낼 때 해당 쿠키가 `Cookie` 헤더에 포함되지 않는다.

- `example.com` server ➡︎ `Set-Cookie: name=value; Domain=test.com` ➡︎ browser
- browser ➡︎ `Cookie: name=value` ➡︎ `exapmle.com` server
- browser ➡︎ No Cookie 요청 ➡︎ `test.com`

```http
Set-Cookie: name=value; Domain=test.com
```

- 브라우저에 `test.com`을 포함하는 도메인들에 공유되는 "name=value" 의 쿠키값을 전달

`blog.test.com` `july.test.com` 등 `test.com`을 포함하고 있는 하위 도메인에 해당 쿠키값을 전달할 수 있다.

- _브라우저는 도메인 문자열을 비교할 때 뒤에서부터 비교한다_

## Path 옵션

**쿠키가 언제 전송되는지 결정하는 옵션**이다. 쿠키 헤더를 정송하기 전에 리소스의 URL 경로에 반드시 존재해야 하는 URL 경로를 지정한다. URL경로를 포함한 Path옵션을 가진 Set-Cookie를 클라이언트로 전송하고 쿠키는 클라이언트 측에 저장된다. 이후 클라이언트가 쿠키를 담은 요청을 보내는데 쿠키의 Path옵션에 따라 쿠키가 전송되는 요청 URL이 제한된다

path옵션값과 url시작부분을 문자 단위로 비교해서 일치하면 쿠키헤더를 전송한다. 하나의 도메인에서 여러가지 서비스를 제공할 때 각 서비스마다 서로 다른 쿠키값을 사용하는 것이 가능해진다.

쿠키 옵션의 기본값은 `Set-Cookie` 헤더를 보낸 URL의 경로이다.

- `https://www.test.com/a/b` 로부터 Set-Cookie 를 받았을 때 기본 Path옵션 값은 `/a/b` 이다.

```http
Set-Cookie: ~ Path=/test
```

도메인 옵션에서 호스트 이름을 비교할 때 뒤에서 부터 했던 것과는 달리 앞에서 부터 문자 단위로 비교를 한다.

- domain/test/index.html ✅
- domain/test/bar/foo ✅
- domain/foo/bar ❌

함정카드

- domain/foobar/boo ✅ : 조심하자

## Secure 옵션

HTTP연결은 안전하지 않아 SSL/TLS 암호화 프로토콜을 사용하는 HTTPS연결을 사용해야 한다. Secure 옵션은 **HTTPS연결을 사용해야만 쿠키가 전송되도록 하는 옵션**이다. HTTPS는 데이터를 암호화하여 중간에서 제3자가 데이터를 쉽게 볼 수 없도록 하기에 꼭! HTTPS와 Secure옵션을 활용하자

쿠키 메커니즘 자체가 안전하지 않기 때문에 아주 중요한 기밀, 민감한 정보는 쿠키에 담지말자.
